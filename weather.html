<!DOCTYPE html>
<html id="#html">
    <head>
        <title>Forecast - Weather API system</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <div id="icon">

        </div>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    </head>
    <body>
        <table id="top"><tr>
            <th>This system is under heavy development, and is liable to issues.</th>
        </tr></table>

        <h1>The forecast</h1>
        <h3>Powered by <a href="https://api.weather.gov">api.weather.gov</a></h3>
        <p>I was bored, so I created this. It is a simple HTML/JS API request system. <b>NOTE: THIS DOES NOT WORK WELL ON MOBILE</b>. I am working very hard on this project, the main system will eventually go into a weather app I am creating. Alerts do not require location.</p>

        <a id="devmode" onclick="showDev()"></a>
        <script>
            function showDev() {
                var currentUrl = document.getElementById('current-forecast-devurl')
                currentUrl.textContent = 'FETCH URL: ' + urlHourlyForecast
                var hourlyUrlEl = document.getElementById('hourly-devurl')
                hourlyUrlEl.textContent = 'FETCH URL: ' + urlHourlyForecast
                var dailyUrlEl = document.getElementById('daily-devurl')
                dailyUrlEl.textContent = 'FETCH URL: ' + urlDailyForecast
            }
        </script>


        <h3 id="tbltitle"></h3>
        <ul id="contents">
        </ul>

        <table id="error"></table>

        <h2 id="current-forecast"></h2>
        <code id="current-forecast-devurl" class="dev"></code>
        <h5 id="currentdesc"></h5>
        <table id="current"></table>

        <h2 id="alerts">Alerts</h2>
        <code id="alert-devurl"></code>
        <h5>Get alerts for any state</h5>
        <p>Enter state</p>
        <input id="statein" type="text" placeholder="ex: OH"> <button onclick="getActiveAlerts()">Go</button>
        <hr />
        <table id="alert"></table>

        <h2 id="hourly"></h2>
        <code id="hourly-devurl"></code>
        <h5 id="hourlydesc"></h5>
        <table id="forecast-hourly"></table>

        <h2 id="daily"></h2>
        <code id="daily-devurl"></code>
        <h5 id="dailydesc"></h5>
        <table id="forecast"></table>

        <a href="#top">Go back to top</a>

        <h2 id="credits">Credits</h2>

        <span id="footer">
            
        </span>
        <script>
            var foot = document.getElementById('footer')
            foot.textContent = 'Created by Piccolowen on 4/29/2020 and last updated on ' + document.lastModified + '. Styling by Bootstrap.'
        </script>

        <script>
            var status = ''
            var locLat = ''
            var locLon = ''
            var urlDaily = ''
            var urlDailyForecast = ''
            var urlHourlyForecast = ''
            var response
            var result
            var arrLen
            var arrNum
            var forecastDaily = document.getElementById('forecast')
            var forecastHourly = document.getElementById('forecast-hourly')
            var err = document.getElementById('error')
            var errMsg = ''
            var hoursUser= new Date()
            var hourUser = hoursUser.getHours()
            var dateUser = new Date()
            var dateUserDay = dateUser.getDate()
            console.log(dateUserDay)
            console.log(hourUser)
            var hourOut
            var currentArrNum
            navigator.geolocation.getCurrentPosition(locSys, locError)
            function locSys(position) {
                locLat = position.coords.latitude
                locLon = position.coords.longitude
                return getStatus()
            }
            async function getStatus() {
                var devmode = document.getElementById('devmode')
                devmode.textContent = 'Enable developer mode'

                var tbl = document.getElementById('tbltitle')
                tbl.textContent = 'Page content'

                var tblOfContents = document.getElementById('contents')
                var currentLink = document.createElement('li')
                var currentLinkA = document.createElement('a')
                currentLinkA.href = '#current-forecast'
                currentLinkA.textContent = 'Current stats'
                currentLink.appendChild(currentLinkA)
                tblOfContents.appendChild(currentLink)
                var alertLink = document.createElement('li')
                var alertLinkA = document.createElement('a')
                alertLinkA.href = '#alerts'
                alertLinkA.textContent = 'Alerts'
                alertLink.appendChild(alertLinkA)
                tblOfContents.appendChild(alertLink)
                var hourlyLink = document.createElement('li')
                var hourlyLinkA = document.createElement('a')
                hourlyLinkA.href = '#hourly'
                hourlyLinkA.textContent = 'Hourly forecast'
                hourlyLink.appendChild(hourlyLinkA)
                tblOfContents.appendChild(hourlyLink)
                var dailyLink = document.createElement('li')
                var dailylLinkA = document.createElement('a')
                dailylLinkA.href = '#daily'
                dailylLinkA.textContent = 'Daily forecast'
                dailyLink.appendChild(dailylLinkA)
                tblOfContents.appendChild(dailyLink)
                var credit = document.createElement('li')
                var creditA = document.createElement('a')
                creditA.href = '#credits'
                creditA.textContent = 'Credits'
                credit.appendChild(creditA)
                tblOfContents.appendChild(credit)

                var url = 'https://api.weather.gov'
                var response = await fetch(url)
                var result = await response.json()
                if (result.status == 'OK') {
                    console.log('API STATUS: ' + result.status)
                    return requestDaily()
                }
                else {
                    console.error(result.status)
                    var statusMsg = document.getElementById('error')
                    var msg = document.createElement('span')
                    msg.textContent = 'Weather API down. (Status: "' + result.status + '")'
                    statusMsg.append(msg)
                }
            }
            async function requestDaily() {
                urlDaily = 'https://api.weather.gov/points/' + locLat + ',' + locLon
                response = await fetch(urlDaily)
                result = await response.json()
                urlDailyForecast = result.properties.forecast
                return dailyData()
            }
            async function dailyData() {
                response = await fetch(urlDailyForecast)
                result = await response.json()
                arrLen = Object.keys(result.properties.periods).length
                arrNum = 0

                var dailyTitle = document.getElementById('daily')
                dailyTitle.textContent = 'Daily forecast'
                var dailyDesc = document.getElementById('dailydesc')
                dailyDesc.textContent = 'The daily forecast'
                while (arrNum < arrLen) {
                    var iconDaily = document.createElement('img')
                    iconDaily.src = result.properties.periods[arrNum].icon
                    iconDaily.className = 'icon'
                    forecastDaily.append(iconDaily)

                    var nameDaily = document.createElement('div')
                    nameDaily.textContent = result.properties.periods[arrNum].name
                    nameDaily.className = 'name'
                    forecastDaily.append(nameDaily)

                    var tempDaily = document.createElement('div')
                    tempDaily.textContent = result.properties.periods[arrNum].temperature
                    tempDaily.className = 'temp'
                    forecastDaily.append(tempDaily)

                    var descDaily = document.createElement('div')
                    descDaily.textContent = result.properties.periods[arrNum].detailedForecast
                    descDaily.className = 'desc'
                    forecastDaily.append(descDaily)

                    arrNum++
                }
                return requestHourly()
            }
            async function requestHourly() {
                response = await fetch(urlDaily)
                result = await response.json()
                urlHourlyForecast = result.properties.forecastHourly
                return dataHourly()
            }
            async function dataHourly() {
                response = await fetch(urlHourlyForecast)
                result = await response.json()
                arrLen = Object.keys(result.properties.periods).length
                arrNum = 0

                var hourlyTitle = document.getElementById('hourly')
                hourlyTitle.textContent = 'Hourly forecast'
                var hourlyDesc = document.getElementById('hourlydesc')
                hourlyDesc.textContent = 'The hourly forecast'
                while (arrNum < arrLen) {
                    var isDay = result.properties.periods[arrNum].isDaytime
                    var iconHourly = document.createElement('img')
                    iconHourly.src = result.properties.periods[arrNum].icon
                    iconHourly.className = 'icon'
                    forecastHourly.append(iconHourly)

                    var starttimeRaw = result.properties.periods[arrNum].startTime
                    var starttimeT = starttimeRaw.split('T')
                    var hourtime = starttimeT[1].split('-', 1)

                    var hour = hourtime[0].split(':', 1)
                    var hourTw = hour[0] - 12
                    if (hour[0] > 12) {
                        hourOut = hourTw + ' PM'
                    }
                    else if (hour[0] == 12) {
                        hourOut = '12 PM'
                    }
                    else if (hour[0] == 00) {
                        hourOut = '12 AM'
                    }
                    else if (hour[0] == 1) {
                        hourOut = hour[0] + ' AM'
                    }
                    else {
                        hourOut = hour[0] + ' AM'
                    }

                    var hourout = document.createElement('div')
                    hourout.textContent = hourOut
                    hourout.className = 'name'
                    forecastHourly.append(hourout)

                    var hourTemp = document.createElement('div')
                    hourTemp.textContent = result.properties.periods[arrNum].temperature
                    hourTemp.className = 'temp'
                    forecastHourly.append(hourTemp)

                    var windState = document.createElement('div')
                    windState.textContent = 'Wind will be around ' + result.properties.periods[arrNum].windSpeed + ' heading ' + result.properties.periods[arrNum].windDirection
                    windState.className = 'wind'
                    forecastHourly.append(windState)

                    var shortForecast = document.createElement('div')
                    shortForecast.textContent = result.properties.periods[arrNum].shortForecast
                    shortForecast.className = 'desc'
                    forecastHourly.append(shortForecast)

                    arrNum++
                }
                return current()
            }
            async function current() {
                response = await fetch(urlHourlyForecast)
                result = await response.json()
                arrLen = Object.keys(result.properties.periods).length
                arrNum = 0
                var currentTitle = document.getElementById('current-forecast')
                currentTitle.textContent = 'Current stats'
                var currentDesc = document.getElementById('currentdesc')
                currentDesc.textContent = 'What\'s it like outside right now'
                while (arrNum < arrLen) {
                    var currentTimeResult = result.properties.periods[arrNum].startTime.split('T', 1)
                    var currenttime = currentTimeResult[0].split(':', 1)
                    var currenttimeout = currenttime[0].split('-', 3)
                    if (currenttimeout[2] == dateUserDay) {
                        var userTime = result.properties.periods[arrNum].startTime.split('T', 2)
                        var usertime = userTime[1].split(':', 1)
                        if (hourUser == usertime[0]) {
                            console.log(arrNum)
                            currentArrNum = arrNum

                            var currentdata = document.getElementById('current')

                            var currenticon = document.createElement('img')
                            currenticon.src = result.properties.periods[currentArrNum].icon
                            currenticon.className = 'icon'
                            currentdata.append(currenticon)

                            var currentTimeofTemp = document.createElement('div')
                            var currentHourOfUser
                            if (hourUser >= 12) {
                                currentHourOfUser = (hourUser - 12) + ' PM'
                            }
                            else {
                                currentHourOfUser = hourUser + ' AM'
                            }
                            currentTimeofTemp.textContent = currentHourOfUser
                            currentTimeofTemp.className = 'name'
                            currentdata.append(currentTimeofTemp)

                            var currentTemp = document.createElement('div')
                            currentTemp.textContent = result.properties.periods[currentArrNum].temperature + 'Â°'
                            currentTemp.className = 'temp'

                            currentdata.append(currentTemp)

                            var curwindState = document.createElement('div')
                            curwindState.textContent = 'Wind will be around ' + result.properties.periods[arrNum].windSpeed + ' heading ' + result.properties.periods[arrNum].windDirection
                            curwindState.className = 'wind'
                            currentdata.append(curwindState)

                            var currentdesc = document.createElement('div')
                            currentdesc.textContent = result.properties.periods[currentArrNum].shortForecast
                            currentdesc.className = 'desc'
                            currentdata.append(currentdesc)

                            var pageIcon = document.getElementById('icon')
                            var ico = document.createElement('link')
                            ico.href = result.properties.periods[currentArrNum].icon
                            ico.rel = 'icon'
                            pageIcon.append(ico)
                        }
                    }

                    arrNum++
                }
            }
            function locError(error) {
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errMsg = 'ERROR: PERMISSION WAS DENIED BY USER'
                        err.append(errMsg)
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errmsg = 'ERROR: LOCATION UNAVAILABLE'
                        err.append(errmsg)
                        break;
                    case error.TIMEOUT:
                        errmsg = 'ERROR: LOCATION TIMEOUT'
                        err.append(errmsg)
                        break;
                    case error.UNKNOWN_ERROR:
                        errmsg = 'ERROR: UNKNOWN ERROR'
                        err.append(errmsg)
                        break;
                }
            }
        </script>
        <script>
            //https://api.weather.gov/alerts/active?area={state}
            async function getActiveAlerts() {
                var stateUser = document.getElementById('statein').value
                var alertUrl = 'https://api.weather.gov/alerts/active?area=' + stateUser
                var alertName = document.createElement('div')
                var alertsOut = document.getElementById('alert')
                alertsOut.textContent = ''
                var arrNum = 0
                response = await fetch(alertUrl)
                result = await response.json()
                var arrLen = Object.keys(result.features).length
                if (result.features != '') {
                    while (arrNum < arrLen) {
                        var alertName = document.createElement('div')
                        alertName.textContent = result.features[arrNum].properties.headline
                        alertName.className = 'name'
                        alertsOut.append(alertName)

                        var alertSev = document.createElement('div')
                        alertSev.textContent = 'Severity: ' + result.features[arrNum].properties.severity
                        alertSev.className = 'sev'
                        alertsOut.append(alertSev)

                        var alertLike = document.createElement('div')
                        alertLike.textContent = 'Certainty: ' + result.features[arrNum].properties.certainty
                        alertLike.className = 'like'
                        alertsOut.append(alertLike)

                        var alertDesc = document.createElement('div')
                        alertDesc.textContent = result.features[arrNum].properties.description
                        alertDesc.className = 'desc'
                        alertsOut.append(alertDesc)

                        var alertInstruc = document.createElement('div')
                        if (result.features[arrNum].properties.instruction == 'null') {
                            alertInstruc.textContent = 'No instructions provided'
                        }
                        else {
                            alertInstruc.textContent = 'Instructions: ' + result.features[arrNum].properties.instruction
                        }
                        alertInstruc.className = 'instruc'
                        alertsOut.append(alertInstruc)

                        var hr = document.createElement('hr')
                        alertsOut.append(hr)

                        arrNum++
                    }
                }
                else {
                    var noAlert = document.createElement('div')
                    noAlert.textContent = 'No alerts for provided state!'
                    noAlert.className = 'noal'
                    alertsOut.append(noAlert)
                }
            }
        </script>
        <style>
            html {
                margin: 0;
                transition: 300ms;
            }
            *{
                transition: 150ms;
            }
            body {
                margin: 5px;
                padding: 5px;
            }
            table {
                border: black;
                border-style: solid;
                width: 100%;
            }
            .name, .temp, .desc, .sev, .like, .noal, .instruc, .wind {
                padding: 5px;
                margin: 10px;
                border: black;
                border-width: 1px;
                border-style: solid;
            }
            .icon {
                padding: 10px;
            }
            table:hover {
                cursor: default;
            }
            .name:hover {
                color: white;
                background-color: green;
            }
            .temp:hover {
                color: white;
                background-color: blue;
            }
            .desc:hover {
                color: white;
                background-color: orangered;
            }
            .wind:hover {
                color: white;
                background-color: fuchsia;
            }
            embed {
                border: black;
                border-style: solid;
            }
            a {
                text-decoration: none;
                color: blue;
                transition: 300ms;
            }
            #top {
                color: white;
                background-color: red;
            }
            .sev:hover {
                color: white;
                background-color: crimson;
            }
            .like:hover {
                color: white;
                background-color: darkgoldenrod;
            }
            .noal:hover {
                color: white;
                background-color: darkorchid;
            }
            .instruc:hover {
                color: white;
                background-color: blueviolet;
            }
            #error {
                color: white;
                background-color: red;
                font-weight: bold;
            }
            #devmode:hover {
                cursor: pointer;
            }
        </style>
    </body>
</html>

<!DOCTYPE html>
<html id="#html">
    <head>
        <title id="top">Forecast - Weather API system</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <div id="icon">

        </div>
    </head>
    <body>
        <table id="top"><tr>
            <th>This system is under heavy development, and is liable to issues.</th>
        </tr></table>

        <h1>The forecast</h1>
        <h3>Powered by <a href="https://api.weather.gov">api.weather.gov</a></h3>
        <p>I was bored, so I created this. It is a simple HTML/JS API request system. <b>NOTE: THIS DOES NOT WORK WELL ON MOBILE</b>. I am working very hard on this project, the main system will eventually go into a weather app I am creating. Alerts do not require location.</p>

        <ul>
            <li><a href="#current-forecast">Current stats</a></li>
            <li><a href="#alerts">Alerts</a></li>
            <li><a href="#hourly">Hourly forecast</a></li>
            <li><a href="#daily">Daily forecast</a></li>
        </ul>

        <span id="error"></span>

        <h2 id="current-forecast">Current stats</h2>
        <table id="current"></table>

        <h2 id="alerts">Alerts</h2>
        <p>Enter state</p>
        <input id="statein" type="text" placeholder="ex: OH"> <button onclick="getActiveAlerts()">Go</button>
        <hr />
        <table id="alert"></table>

        <h2 id="hourly">Hourly forecast</h2>
        <table id="forecast-hourly"></table>

        <h2 id="daily">Daily forecast</h2>
        <table id="forecast"></table>

        <a href="#top">Go back to top</a>

        <span id="footer">
            Created by Piccolowen on 4/29/2020 and updated on 5/4/2020
        </span>

        <script>
            var status = ''
            var locLat = ''
            var locLon = ''
            var urlDaily = ''
            var urlDailyForecast = ''
            var urlHourlyForecast = ''
            var response
            var result
            var arrLen
            var arrNum
            var forecastDaily = document.getElementById('forecast')
            var forecastHourly = document.getElementById('forecast-hourly')
            var err = document.getElementById('error')
            var errMsg = ''
            var hoursUser= new Date()
            var hourUser = hoursUser.getHours()
            var dateUser = new Date()
            var dateUserDay = dateUser.getDate()
            console.log(dateUserDay)
            console.log(hourUser)
            var hourOut
            var currentArrNum
            navigator.geolocation.getCurrentPosition(locSys, locError)
            function locSys(position) {
                locLat = position.coords.latitude
                locLon = position.coords.longitude
                return getStatus()
            }
            async function getStatus() {
                var url = 'https://api.weather.gov'
                var response = await fetch(url)
                var result = await response.json()
                if (result.status == 'OK') {
                    console.log('API STATUS: ' + result.status)
                    return requestDaily()
                }
                else {
                    console.error(result.status)
                    var statusMsg = document.getElementById('error')
                    var msg = document.createElement('span')
                    msg.textContent = 'Weather API down. (Status: "' + result.status + '")'
                    statusMsg.append(msg)
                }
            }
            async function requestDaily() {
                urlDaily = 'https://api.weather.gov/points/' + locLat + ',' + locLon
                response = await fetch(urlDaily)
                result = await response.json()
                urlDailyForecast = result.properties.forecast
                return dailyData()
            }
            async function dailyData() {
                response = await fetch(urlDailyForecast)
                result = await response.json()
                arrLen = Object.keys(result.properties.periods).length
                arrNum = 0
                while (arrNum < arrLen) {
                    var iconDaily = document.createElement('img')
                    iconDaily.src = result.properties.periods[arrNum].icon
                    iconDaily.className = 'icon'
                    forecastDaily.append(iconDaily)

                    var nameDaily = document.createElement('div')
                    nameDaily.textContent = result.properties.periods[arrNum].name
                    nameDaily.className = 'name'
                    forecastDaily.append(nameDaily)

                    var tempDaily = document.createElement('div')
                    tempDaily.textContent = result.properties.periods[arrNum].temperature
                    tempDaily.className = 'temp'
                    forecastDaily.append(tempDaily)

                    var descDaily = document.createElement('div')
                    descDaily.textContent = result.properties.periods[arrNum].detailedForecast
                    descDaily.className = 'desc'
                    forecastDaily.append(descDaily)

                    arrNum++
                }
                return requestHourly()
            }
            async function requestHourly() {
                response = await fetch(urlDaily)
                result = await response.json()
                urlHourlyForecast = result.properties.forecastHourly
                return dataHourly()
            }
            async function dataHourly() {
                response = await fetch(urlHourlyForecast)
                result = await response.json()
                arrLen = Object.keys(result.properties.periods).length
                arrNum = 0
                while (arrNum < arrLen) {
                    var isDay = result.properties.periods[arrNum].isDaytime
                    var iconHourly = document.createElement('img')
                    iconHourly.src = result.properties.periods[arrNum].icon
                    iconHourly.className = 'icon'
                    forecastHourly.append(iconHourly)

                    var starttimeRaw = result.properties.periods[arrNum].startTime
                    var starttimeT = starttimeRaw.split('T')
                    var hourtime = starttimeT[1].split('-', 1)

                    var hour = hourtime[0].split(':', 1)
                    var hourTw = hour[0] - 12
                    if (hour[0] > 12) {
                        hourOut = hourTw + ' PM'
                    }
                    else if (hour[0] == 12) {
                        hourOut = '12 PM'
                    }
                    else if (hour[0] == 00) {
                        hourOut = '12 AM'
                    }
                    else if (hour[0] == 1) {
                        hourOut = hour[0] + ' AM'
                    }
                    else {
                        hourOut = hour[0] + ' AM'
                    }

                    var hourout = document.createElement('div')
                    hourout.textContent = hourOut
                    hourout.className = 'name'
                    forecastHourly.append(hourout)

                    var hourTemp = document.createElement('div')
                    hourTemp.textContent = result.properties.periods[arrNum].temperature
                    hourTemp.className = 'temp'
                    forecastHourly.append(hourTemp)

                    var shortForecast = document.createElement('div')
                    shortForecast.textContent = result.properties.periods[arrNum].shortForecast
                    shortForecast.className = 'desc'
                    forecastHourly.append(shortForecast)

                    arrNum++
                }
                return current()
            }
            async function current() {
                response = await fetch(urlHourlyForecast)
                result = await response.json()
                arrLen = Object.keys(result.properties.periods).length
                arrNum = 0
                while (arrNum < arrLen) {
                    var currentTimeResult = result.properties.periods[arrNum].startTime.split('T', 1)
                    var currenttime = currentTimeResult[0].split(':', 1)
                    var currenttimeout = currenttime[0].split('-', 3)
                    if (currenttimeout[2] == dateUserDay) {
                        var userTime = result.properties.periods[arrNum].startTime.split('T', 2)
                        var usertime = userTime[1].split(':', 1)
                        if (hourUser == usertime[0]) {
                            console.log(arrNum)
                            currentArrNum = arrNum

                            var currentdata = document.getElementById('current')

                            var currenticon = document.createElement('img')
                            currenticon.src = result.properties.periods[currentArrNum].icon
                            currenticon.className = 'icon'
                            currentdata.append(currenticon)

                            var currentTimeofTemp = document.createElement('div')
                            currentTimeofTemp.textContent = hourUser
                            currentTimeofTemp.className = 'name'
                            currentdata.append(currentTimeofTemp)

                            var currentTemp = document.createElement('div')
                            currentTemp.textContent = result.properties.periods[currentArrNum].temperature
                            currentTemp.className = 'temp'

                            currentdata.append(currentTemp)

                            var currentdesc = document.createElement('div')
                            currentdesc.textContent = result.properties.periods[currentArrNum].shortForecast
                            currentdesc.className = 'desc'
                            currentdata.append(currentdesc)

                            var pageIcon = document.getElementById('icon')
                            var ico = document.createElement('link')
                            ico.href = result.properties.periods[currentArrNum].icon
                            ico.rel = 'icon'
                            pageIcon.append(ico)
                        }
                    }

                    arrNum++
                }
            }
            function locError(error) {
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errMsg = 'PERMISSION_DENIED'
                        err.append(errMsg)
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errmsg = 'Location unavailable'
                        err.append(errmsg)
                        break;
                    case error.TIMEOUT:
                        errmsg = 'Location timeout'
                        err.append(errmsg)
                        break;
                    case error.UNKNOWN_ERROR:
                        errmsg = 'An unknown error occurred'
                        err.append(errmsg)
                        break;
                }
            }
        </script>
        <script>
            //https://api.weather.gov/alerts/active?area={state}
            async function getActiveAlerts() {
                var stateUser = document.getElementById('statein').value
                var alertUrl = 'https://api.weather.gov/alerts/active?area=' + stateUser
                var alertName = document.createElement('div')
                var alertsOut = document.getElementById('alert')
                alertsOut.textContent = ''
                var arrNum = 0
                response = await fetch(alertUrl)
                result = await response.json()
                var arrLen = Object.keys(result.features).length
                if (result.features != '') {
                    while (arrNum < arrLen) {
                        var alertName = document.createElement('div')
                        alertName.textContent = result.features[arrNum].properties.headline
                        alertName.className = 'name'
                        alertsOut.append(alertName)

                        var alertSev = document.createElement('div')
                        alertSev.textContent = 'Severity: ' + result.features[arrNum].properties.severity
                        alertSev.className = 'sev'
                        alertsOut.append(alertSev)

                        var alertLike = document.createElement('div')
                        alertLike.textContent = 'Certainty: ' + result.features[arrNum].properties.certainty
                        alertLike.className = 'like'
                        alertsOut.append(alertLike)

                        var alertDesc = document.createElement('div')
                        alertDesc.textContent = result.features[arrNum].properties.description
                        alertDesc.className = 'desc'
                        alertsOut.append(alertDesc)

                        var hr = document.createElement('hr')
                        alertsOut.append(hr)

                        arrNum++
                    }
                }
                else {
                    var noAlert = document.createElement('div')
                    noAlert.textContent = 'No alerts for provided state!'
                    noAlert.className = 'noal'
                    alertsOut.append(noAlert)
                }
            }
        </script>
        <style>
            html {
                margin: 0;
            }
            body {
                margin: 5px;
                padding: 5px;
            }
            table {
                border: black;
                border-style: solid;
                width: 100%;
            }
            .name, .temp, .desc, .sev, .like, .noal {
                padding: 5px;
                margin: 10px;
                border: black;
                border-width: 1px;
                border-style: solid;
            }
            .icon {
                padding: 10px;
            }
            table:hover {
                cursor: default;
            }
            .name:hover {
                color: white;
                background-color: green;
            }
            .temp:hover {
                color: white;
                background-color: blue;
            }
            .desc:hover {
                color: white;
                background-color: orangered;
            }
            embed {
                border: black;
                border-style: solid;
            }
            a {
                text-decoration: none;
                color: blue;
                transition: 300ms;
            }
            #top {
                color: white;
                background-color: red;
            }
            .sev:hover {
                color: white;
                background-color: crimson;
            }
            .like:hover {
                color: white;
                background-color: darkgoldenrod;
            }
            .noal:hover {
                color: white;
                background-color: darkorchid;
            }
        </style>
    </body>
</html>
